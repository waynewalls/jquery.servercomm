/**
 *  jQuery.servercomm plugin -- UI and API for $.ajax() requests
 *  Copyright (c) 2010 Wayne Walls - wfwalls(at)gmail(dot)com
 *  License: MIT License or GNU General Public License (GPL) Version 2
 *  Date: 28 June 2010
 *  @author Wayne Walls
 *  @version 0.9
 */
;(function(i,k,h){var g=(h.browser.msie&&parseInt(h.browser.version,10)===6),a=[(g)?"body { background: url(images/clear1.gif) fixed; }":"","#sc_contactServerPrompt{ font-weight:bold; text-align:center; left:0px; width:100%;",(g)?"position: absolute; top: expression((document.documentElement || document.body).scrollTop);":"position:fixed; top:0px;","}","#sc_contactServerPrompt img { vertical-align:-2px; }","#sc_contactServerPrompt span { cursor:default; }",".sc_hand { cursor:pointer; }",".sc_blue { padding:0 1em; background-color:#999; color:#8ef; }",".sc_yellow { padding:0 1em; background-color:#666; color:yellow; }",".sc_green { padding:0 1em; background-color:#666; color:#5f5; }",".sc_red { padding:0 1em; background-color:#FD2F00; color:white; }",".sc_inprocess { font-size:130%; font-weight:bold; color:white; background-color:red; padding:10px; border:solid 5px #d00; position:absolute }"].join(""),j=h("<style />").attr("type","text/css"),e=h("<div />",{id:"sc_contactServerPrompt",html:"<span class='sc_blue'><img /> <span></span></span>"}),p=e.find("> span"),d=e.find("img"),l=e.find("span span"),n,m=1,b=null,o=false,c=function(r){var q=h.serverComm.options;r=r||"";if(q.giveupCallback){if(h.isFunction(q.giveupCallback)){q.giveupCallback.call()}}m=1;e.fadeTo("fast",0,function(){e.detach().removeAttr("style");p.removeClass("sc_red").addClass("sc_blue").removeAttr("title");l.html(q.contactPromptText);d.removeAttr("style").attr("src",q.contactImagePath);o=false})},f=function(r){var q=h.serverComm.options;r=r||"";b=null;if(q.errorCallback){if(h.isFunction(q.errorCallback)){q.errorCallback.call(null,r,m)}}m+=1;if(m<=h.serverComm.options.autoRetrys){p.removeClass("sc_blue").addClass("sc_yellow");d.attr("src",q.problemImagePath);l.html("There's been a problem &mdash; Trying again. . . "+m+" of "+h.serverComm.options.autoRetrys);o=false;h.serverComm.contactServer()}else{p.removeClass("sc_yellow").addClass("sc_red").attr("title",r);d.css({display:"none"});l.html(q.giveupPromptText+"&nbsp;&nbsp;<img class='sc_hand' src='"+q.closeBoxImagePath+"'>");h(k).one("click",function(){if(e.length===1){c(r)}})}};h(k).ready(function(){var q=h.serverComm.options;if(j[0].styleSheet){j[0].styleSheet.cssText=a}else{j.text(a)}j.prependTo("head");l.html(q.contactPromptText);d.attr("src",q.contactImagePath)});h.serverComm={options:{url:"",dataObject:null,autoRetrys:4,autoTimeout:7000,giveupCallback:null,errorCallback:null,successCallback:null,contactPromptText:"Contacting server",giveupPromptText:"The problem hasn't gone away &mdash; try again later",successPromptText:"Contacting server &mdash; SUCCESS!",contactImagePath:"images/busy999.gif",problemImagePath:"images/busy666.gif",closeBoxImagePath:"images/close.gif",responseSeparator:"|"},configure:function(q){q=q||{};this.options=h.extend(this.options,q)},activeConnection:function(){return(b&&o)},inprocessWarning:function(){var q=h(i),r;r=h("<div />",{className:"sc_inprocess",text:"Please Wait!"}).appendTo("body");r.css({top:(q.height()-r.outerHeight())/2+q.scrollTop(),left:(q.width()-r.outerWidth())/2+q.scrollLeft()});setTimeout(function(){r.fadeTo("slow",0,function(){r.remove()})},1000)},contactServer:function(q){q=q||{};this.options=h.extend(this.options,q);n=setInterval(function(){if(!b&&!o){clearInterval(n);o=true;if(m===1){l.html(h.serverComm.options.contactPromptText);d.attr("src",h.serverComm.options.contactImagePath)}e.appendTo("body");try{b=h.ajax({url:h.serverComm.options.url,type:"POST",data:h.serverComm.options.dataObject,datatype:"text",timeout:h.serverComm.options.autoTimeout,error:function(v,u,t){var s="";if(u==="timeout"){s=u}else{if(u==="error"){s="internet error"}else{s="unknown"}}f(s)},success:function(t,s){var v=h.serverComm.options,u;u=(t.indexOf(v.responseSeparator)===-1)?t:t.split("|")[0];if(u!=="success"){f(u)}else{if(m>1){b=null;e.detach();d.css({display:"none"});p.removeClass("sc_yellow").addClass("sc_green");l.html(v.successPromptText);e.appendTo("body");setTimeout(function(){e.fadeTo("slow",0,function(){e.detach().removeAttr("style");p.removeClass("sc_green").addClass("sc_blue");l.html(v.contactPromptText);d.removeAttr("style").attr("src",v.contactImagePath);o=false})},2000)}else{b=null;setTimeout(function(){e.fadeTo("slow",0,function(){e.detach().removeAttr("style");o=false})},750)}if(h.serverComm.options.successCallback){if(h.isFunction(h.serverComm.options.successCallback)){h.serverComm.options.successCallback.call(null,t,m)}}m=1}}})}catch(r){f("ajax failure")}}},100)}}}(window,document,jQuery));